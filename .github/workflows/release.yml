name: Build and Release Flutter APK

on:
  push:
    tags:
      - 'v*'  # Dispara quando criar tag v1.0.0, v1.1.0, etc

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
      
      - name: Get dependencies
        working-directory: ./kimo_overlay
        run: flutter pub get
      
      - name: Build APK
        working-directory: ./kimo_overlay
        run: flutter build apk --release
      
      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: KIMO Overlay ${{ steps.version.outputs.VERSION }}
          body: |
            ğŸ“± **KIMO Overlay** - DecisÃµes Inteligentes em Segundos
            
            ğŸš¦ SemÃ¡foro overlay para motoristas de Uber/99
            
            ## ğŸ†• Novidades desta versÃ£o
            
            - Overlay inteligente sobre apps de corrida
            - AnÃ¡lise automÃ¡tica de custos e lucro
            - EstatÃ­sticas em tempo real
            - Acompanhamento de meta diÃ¡ria
            
            ## ğŸ“¦ InstalaÃ§Ã£o
            
            1. **Baixar** `KIMO-Overlay.apk` abaixo
            2. **Permitir** "Instalar apps desconhecidos" (Android vai perguntar)
            3. **Instalar** o APK
            4. **Abrir** o app e fazer login com seu telefone
            
            ## âš ï¸ PermissÃµes NecessÃ¡rias
            
            O app vai pedir:
            - ğŸ”” Acesso a notificaÃ§Ãµes (para detectar corridas)
            - ğŸªŸ Exibir sobre outros apps (para mostrar overlay)
            
            ## ğŸ†˜ Problemas?
            
            Veja o [README](https://github.com/gapinto/kimo/blob/main/kimo_overlay/README.md) ou abra uma [Issue](https://github.com/gapinto/kimo/issues)
            
            ---
            
            **Desenvolvido com â¤ï¸ para motoristas**
          draft: false
          prerelease: false
      
      - name: Upload APK to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./kimo_overlay/build/app/outputs/flutter-apk/app-release.apk
          asset_name: KIMO-Overlay.apk
          asset_content_type: application/vnd.android.package-archive

